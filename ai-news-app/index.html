<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="AI News">
  <meta name="theme-color" content="#0a0a1a">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <title>AI ニュース Hub</title>
  <style>
    :root {
      --bg: #0a0a1a;
      --surface: #141428;
      --surface-hover: #1c1c3a;
      --border: #2a2a4a;
      --text: #e8e8f0;
      --text-dim: #8888aa;
      --accent: #6366f1;
      --accent-glow: rgba(99, 102, 241, 0.3);
      --cat-llm: #8b5cf6;
      --cat-image: #ec4899;
      --cat-research: #06b6d4;
      --cat-business: #f59e0b;
      --cat-regulation: #10b981;
      --cat-coding: #f97316;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      min-height: 100dvh;
      overflow-x: hidden;
      -webkit-tap-highlight-color: transparent;
    }

    /* Header */
    .header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: rgba(10, 10, 26, 0.85);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      padding: calc(var(--safe-top) + 8px) 16px 0;
      border-bottom: 1px solid var(--border);
    }

    .header-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-icon {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, var(--accent), #a855f7);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .logo-text {
      font-size: 20px;
      font-weight: 700;
      background: linear-gradient(135deg, #6366f1, #a855f7);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .refresh-btn {
      width: 44px;
      height: 44px;
      border: none;
      background: var(--surface);
      border-radius: 12px;
      color: var(--accent);
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
      border: 1px solid var(--border);
    }

    .refresh-btn:active {
      transform: scale(0.9);
      background: var(--accent);
      color: white;
    }

    .refresh-btn.spinning svg {
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Category Tabs */
    .tabs {
      display: flex;
      gap: 6px;
      overflow-x: auto;
      scrollbar-width: none;
      -ms-overflow-style: none;
      padding-bottom: 12px;
      scroll-snap-type: x mandatory;
    }

    .tabs::-webkit-scrollbar { display: none; }

    .tab {
      flex-shrink: 0;
      padding: 8px 14px;
      border-radius: 20px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text-dim);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      white-space: nowrap;
      scroll-snap-align: start;
      font-family: inherit;
    }

    .tab.active {
      color: white;
      border-color: transparent;
    }

    .tab[data-cat="all"].active { background: var(--accent); }
    .tab[data-cat="llm"].active { background: var(--cat-llm); }
    .tab[data-cat="image"].active { background: var(--cat-image); }
    .tab[data-cat="research"].active { background: var(--cat-research); }
    .tab[data-cat="business"].active { background: var(--cat-business); }
    .tab[data-cat="regulation"].active { background: var(--cat-regulation); }
    .tab[data-cat="coding"].active { background: var(--cat-coding); }

    /* Content */
    .content {
      padding: 16px;
      padding-bottom: calc(var(--safe-bottom) + 80px);
    }

    .status-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      font-size: 12px;
      color: var(--text-dim);
    }

    .status-bar .count {
      background: var(--surface);
      padding: 4px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
    }

    .translate-status {
      font-size: 11px;
      color: var(--accent);
      padding: 6px 12px;
      background: rgba(99, 102, 241, 0.1);
      border: 1px solid rgba(99, 102, 241, 0.2);
      border-radius: 8px;
      margin-bottom: 12px;
      text-align: center;
      display: none;
    }

    /* Article Cards */
    .card-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
      color: inherit;
      display: block;
    }

    .card:active {
      transform: scale(0.98);
      background: var(--surface-hover);
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
    }

    .card-badge {
      font-size: 11px;
      font-weight: 600;
      padding: 3px 8px;
      border-radius: 6px;
      color: white;
    }

    .card-badge.llm { background: var(--cat-llm); }
    .card-badge.image { background: var(--cat-image); }
    .card-badge.research { background: var(--cat-research); }
    .card-badge.business { background: var(--cat-business); }
    .card-badge.regulation { background: var(--cat-regulation); }
    .card-badge.coding { background: var(--cat-coding); }

    .card-time {
      font-size: 11px;
      color: var(--text-dim);
      margin-left: auto;
    }

    .card-title {
      font-size: 15px;
      font-weight: 600;
      line-height: 1.6;
      margin-bottom: 4px;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .card-title-en {
      font-size: 11px;
      color: var(--text-dim);
      line-height: 1.4;
      margin-bottom: 8px;
      display: -webkit-box;
      -webkit-line-clamp: 1;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .card-meta {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 12px;
      color: var(--text-dim);
    }

    .card-points {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .card-source {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    /* Loading */
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 20px;
      gap: 16px;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    .loading-text {
      font-size: 14px;
      color: var(--text-dim);
    }

    /* Empty State */
    .empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 20px;
      gap: 12px;
      text-align: center;
    }

    .empty-icon {
      font-size: 48px;
      opacity: 0.5;
    }

    .empty-text {
      font-size: 14px;
      color: var(--text-dim);
    }

    /* Error */
    .error-banner {
      background: rgba(239, 68, 68, 0.15);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 12px;
      padding: 12px 16px;
      margin-bottom: 16px;
      font-size: 13px;
      color: #fca5a5;
      display: none;
    }

    /* Fade-in animation */
    .fade-in {
      animation: fadeIn 0.3s ease-out forwards;
      opacity: 0;
    }

    @keyframes fadeIn {
      to { opacity: 1; }
    }

    .card:nth-child(1) { animation-delay: 0s; }
    .card:nth-child(2) { animation-delay: 0.05s; }
    .card:nth-child(3) { animation-delay: 0.05s; }
    .card:nth-child(4) { animation-delay: 0.05s; }
    .card:nth-child(5) { animation-delay: 0.05s; }

    /* Skeleton loading */
    .skeleton {
      background: linear-gradient(90deg, var(--surface) 25%, var(--surface-hover) 50%, var(--surface) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: 8px;
    }

    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    .skeleton-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
    }

    .skeleton-badge { width: 60px; height: 22px; }
    .skeleton-title { width: 100%; height: 20px; margin: 10px 0 6px; }
    .skeleton-title2 { width: 70%; height: 20px; margin-bottom: 10px; }
    .skeleton-meta { width: 120px; height: 14px; }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-top">
      <div class="logo">
        <div class="logo-icon">&#x26A1;</div>
        <span class="logo-text">AI ニュース</span>
      </div>
      <button class="refresh-btn" id="refreshBtn" aria-label="更新">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M21.5 2v6h-6M2.5 22v-6h6"/>
          <path d="M2.5 11.5a10 10 0 0 1 16.5-5.5L21.5 8M21.5 12.5a10 10 0 0 1-16.5 5.5L2.5 16"/>
        </svg>
      </button>
    </div>
    <div class="tabs" id="tabs">
      <button class="tab active" data-cat="all">&#x1F30D; すべて</button>
      <button class="tab" data-cat="llm">&#x1F4AC; LLM</button>
      <button class="tab" data-cat="image">&#x1F3A8; 画像・動画</button>
      <button class="tab" data-cat="research">&#x1F4D1; 研究・論文</button>
      <button class="tab" data-cat="business">&#x1F4BC; ビジネス</button>
      <button class="tab" data-cat="regulation">&#x2696;&#xFE0F; 倫理・規制</button>
      <button class="tab" data-cat="coding">&#x1F4BB; コーディング</button>
    </div>
  </div>

  <div class="content">
    <div class="error-banner" id="errorBanner"></div>
    <div class="status-bar" id="statusBar">
      <span id="lastUpdated">読み込み中...</span>
      <span style="font-size:11px;color:var(--text-dim)">過去7日間</span>
      <span class="count" id="articleCount">-</span>
    </div>
    <div class="translate-status" id="translateStatus">
      &#x1F1EF;&#x1F1F5; 日本語に翻訳中... <span id="translateProgress"></span>
    </div>
    <div class="card-list" id="cardList"></div>
  </div>

  <script>
    // Category definitions with search keywords
    const CATEGORIES = {
      llm: {
        label: 'LLM',
        keywords: ['ChatGPT', 'Claude', 'Gemini', 'LLM', 'GPT-4', 'GPT-5', 'language model', 'Llama', 'Mistral', 'OpenAI chat', 'Anthropic Claude'],
        badgeClass: 'llm'
      },
      image: {
        label: '画像・動画',
        keywords: ['Stable Diffusion', 'Midjourney', 'DALL-E', 'Sora', 'image generation', 'video generation', 'text-to-image', 'Flux', 'Runway', 'generative art'],
        badgeClass: 'image'
      },
      research: {
        label: '研究',
        keywords: ['AI research', 'machine learning paper', 'neural network', 'transformer', 'deep learning', 'arxiv', 'AI breakthrough', 'benchmark', 'reasoning'],
        badgeClass: 'research'
      },
      business: {
        label: 'ビジネス',
        keywords: ['OpenAI', 'Anthropic', 'Google AI', 'Microsoft AI', 'AI startup', 'AI funding', 'AI acquisition', 'AI company', 'Meta AI', 'xAI'],
        badgeClass: 'business'
      },
      regulation: {
        label: '倫理・規制',
        keywords: ['AI regulation', 'AI safety', 'AI ethics', 'AI alignment', 'AI policy', 'AI governance', 'AI bias', 'AI risk', 'EU AI Act'],
        badgeClass: 'regulation'
      },
      coding: {
        label: 'コーディング',
        keywords: ['GitHub Copilot', 'Cursor', 'AI coding', 'code generation', 'Devin', 'AI developer', 'AI programming', 'Claude Code', 'Windsurf', 'Codex'],
        badgeClass: 'coding'
      }
    };

    let allArticles = [];
    let currentCategory = 'all';

    // ========== Translation System ==========

    // Load translation cache from localStorage
    function loadTranslationCache() {
      try {
        return JSON.parse(localStorage.getItem('ai_news_translations') || '{}');
      } catch { return {}; }
    }

    // Save translation cache to localStorage
    function saveTranslationCache(cache) {
      try {
        localStorage.setItem('ai_news_translations', JSON.stringify(cache));
      } catch { /* ignore */ }
    }

    // Translate a single text using MyMemory API (free, no key required)
    async function translateText(text) {
      try {
        const res = await fetch(
          `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=en|ja`
        );
        const data = await res.json();
        if (data.responseStatus === 200 && data.responseData.translatedText) {
          const translated = data.responseData.translatedText;
          // MyMemory returns the original text if it cannot translate
          if (translated.toLowerCase() === text.toLowerCase()) return null;
          return translated;
        }
        return null;
      } catch {
        return null;
      }
    }

    // Translate all articles with progress updates
    async function translateArticles() {
      const cache = loadTranslationCache();
      const statusEl = document.getElementById('translateStatus');
      const progressEl = document.getElementById('translateProgress');

      // Count how many need translation
      const needTranslation = allArticles.filter(a => !cache[a.id]);
      if (needTranslation.length === 0) {
        // All cached, apply translations immediately
        applyTranslations(cache);
        return;
      }

      statusEl.style.display = 'block';
      let translated = 0;

      // Translate in batches with delays to respect rate limits
      for (const article of needTranslation) {
        if (cache[article.id]) continue;

        progressEl.textContent = `(${translated + 1}/${needTranslation.length})`;

        const result = await translateText(article.title);
        if (result) {
          cache[article.id] = result;
        } else {
          cache[article.id] = ''; // mark as attempted to avoid retrying
        }

        translated++;

        // Apply partial translations every 5 articles for progressive UX
        if (translated % 5 === 0) {
          saveTranslationCache(cache);
          applyTranslations(cache);
        }

        // Small delay between requests (rate limit: ~10 req/sec for free tier)
        await new Promise(r => setTimeout(r, 300));
      }

      saveTranslationCache(cache);
      applyTranslations(cache);
      statusEl.style.display = 'none';
    }

    // Apply translations to the article data and re-render
    function applyTranslations(cache) {
      for (const article of allArticles) {
        if (cache[article.id] && cache[article.id] !== '') {
          article.titleJa = cache[article.id];
        }
      }
      renderArticles();
    }

    // ========== Core App Logic ==========

    // Classify an article into a category based on title
    function classifyArticle(title) {
      const lowerTitle = title.toLowerCase();
      let bestMatch = null;
      let bestScore = 0;

      for (const [cat, config] of Object.entries(CATEGORIES)) {
        for (const kw of config.keywords) {
          if (lowerTitle.includes(kw.toLowerCase())) {
            const score = kw.length;
            if (score > bestScore) {
              bestScore = score;
              bestMatch = cat;
            }
          }
        }
      }
      return bestMatch || 'business';
    }

    // Time ago formatting (Japanese)
    function timeAgo(dateStr) {
      const now = Date.now();
      const then = new Date(dateStr).getTime();
      const diff = Math.floor((now - then) / 1000);

      if (diff < 60) return 'たった今';
      if (diff < 3600) return `${Math.floor(diff / 60)}分前`;
      if (diff < 86400) return `${Math.floor(diff / 3600)}時間前`;
      if (diff < 604800) return `${Math.floor(diff / 86400)}日前`;
      return `${Math.floor(diff / 604800)}週間前`;
    }

    // Show skeleton loading
    function showSkeleton() {
      const list = document.getElementById('cardList');
      list.innerHTML = Array(5).fill('').map(() => `
        <div class="skeleton-card">
          <div style="display:flex;gap:8px;margin-bottom:10px">
            <div class="skeleton skeleton-badge"></div>
          </div>
          <div class="skeleton skeleton-title"></div>
          <div class="skeleton skeleton-title2"></div>
          <div class="skeleton skeleton-meta"></div>
        </div>
      `).join('');
    }

    // Fetch AI news from Hacker News Algolia API (past 7 days)
    async function fetchNews() {
      const btn = document.getElementById('refreshBtn');
      btn.classList.add('spinning');
      showSkeleton();
      document.getElementById('errorBanner').style.display = 'none';
      document.getElementById('translateStatus').style.display = 'none';

      try {
        const oneWeekAgo = Math.floor((Date.now() - 7 * 24 * 60 * 60 * 1000) / 1000);

        const queries = [
          'AI artificial intelligence',
          'ChatGPT Claude Gemini LLM',
          'machine learning deep learning',
          'OpenAI Anthropic',
          'AI coding copilot',
          'stable diffusion midjourney',
        ];

        const results = await Promise.all(
          queries.map(q =>
            fetch(`https://hn.algolia.com/api/v1/search?query=${encodeURIComponent(q)}&tags=story&hitsPerPage=30&numericFilters=created_at_i>${oneWeekAgo}`)
              .then(r => r.json())
              .catch(() => ({ hits: [] }))
          )
        );

        // Merge and deduplicate
        const seen = new Set();
        allArticles = [];

        for (const result of results) {
          for (const hit of (result.hits || [])) {
            if (seen.has(hit.objectID)) continue;
            seen.add(hit.objectID);

            const category = classifyArticle(hit.title || '');
            allArticles.push({
              id: hit.objectID,
              title: hit.title,
              titleJa: null, // will be populated by translation
              url: hit.url || `https://news.ycombinator.com/item?id=${hit.objectID}`,
              hnUrl: `https://news.ycombinator.com/item?id=${hit.objectID}`,
              points: hit.points || 0,
              comments: hit.num_comments || 0,
              author: hit.author,
              date: hit.created_at,
              category: category,
              source: extractDomain(hit.url)
            });
          }
        }

        // Sort by points (popularity)
        allArticles.sort((a, b) => b.points - a.points);

        // Apply any cached translations immediately
        const cache = loadTranslationCache();
        applyTranslations(cache);

        // Cache the results
        try {
          localStorage.setItem('ai_news_cache', JSON.stringify({
            articles: allArticles,
            timestamp: Date.now()
          }));
        } catch (e) { /* ignore */ }

        updateStatus();

        // Start translating in background
        translateArticles();

      } catch (err) {
        console.error('Fetch error:', err);
        document.getElementById('errorBanner').textContent = 'データの取得に失敗しました。通信状況を確認してもう一度お試しください。';
        document.getElementById('errorBanner').style.display = 'block';
        loadFromCache();
      } finally {
        btn.classList.remove('spinning');
      }
    }

    // Extract domain from URL
    function extractDomain(url) {
      if (!url) return 'news.ycombinator.com';
      try {
        return new URL(url).hostname.replace('www.', '');
      } catch {
        return 'news.ycombinator.com';
      }
    }

    // Load from cache
    function loadFromCache() {
      try {
        const cached = JSON.parse(localStorage.getItem('ai_news_cache'));
        if (cached && cached.articles) {
          allArticles = cached.articles;
          const transCache = loadTranslationCache();
          applyTranslations(transCache);
          updateStatus(cached.timestamp);
        }
      } catch (e) { /* no cache */ }
    }

    // Render articles based on current filter
    function renderArticles() {
      const list = document.getElementById('cardList');
      const filtered = currentCategory === 'all'
        ? allArticles
        : allArticles.filter(a => a.category === currentCategory);

      document.getElementById('articleCount').textContent = `${filtered.length} 件`;

      if (filtered.length === 0) {
        list.innerHTML = `
          <div class="empty">
            <div class="empty-icon">&#x1F50D;</div>
            <div class="empty-text">このカテゴリの記事は見つかりませんでした</div>
          </div>
        `;
        return;
      }

      list.innerHTML = filtered.map((article, i) => {
        const cat = CATEGORIES[article.category];
        const displayTitle = article.titleJa || article.title;
        const showOriginal = article.titleJa ? article.title : '';
        return `
          <a href="${escapeHtml(article.url)}" target="_blank" rel="noopener" class="card fade-in" style="animation-delay:${Math.min(i, 10) * 0.05}s">
            <div class="card-header">
              <span class="card-badge ${cat.badgeClass}">${cat.label}</span>
              <span class="card-time">${timeAgo(article.date)}</span>
            </div>
            <div class="card-title">${escapeHtml(displayTitle)}</div>
            ${showOriginal ? `<div class="card-title-en">${escapeHtml(showOriginal)}</div>` : ''}
            <div class="card-meta">
              <span class="card-points">&#x25B2; ${article.points}</span>
              <span class="card-source">&#x1F517; ${escapeHtml(article.source)}</span>
              <span>&#x1F4AC; ${article.comments}</span>
            </div>
          </a>
        `;
      }).join('');
    }

    function escapeHtml(str) {
      if (!str) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    // Update status bar
    function updateStatus(timestamp) {
      const ts = timestamp || Date.now();
      const date = new Date(ts);
      const hh = String(date.getHours()).padStart(2, '0');
      const mm = String(date.getMinutes()).padStart(2, '0');
      document.getElementById('lastUpdated').textContent = `最終更新: ${hh}:${mm}`;
    }

    // Tab switching
    document.getElementById('tabs').addEventListener('click', (e) => {
      const tab = e.target.closest('.tab');
      if (!tab) return;

      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      currentCategory = tab.dataset.cat;
      renderArticles();
    });

    // Refresh button
    document.getElementById('refreshBtn').addEventListener('click', fetchNews);

    // Init: load cache first, then fetch fresh data
    loadFromCache();
    fetchNews();
  </script>
</body>
</html>
